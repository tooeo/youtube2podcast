name: Test and CI v4

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        # Updated Python versions - removed 3.9, using 3.10, 3.11, 3.12
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4
    
    - name: Clear GitHub Actions cache
      run: |
        echo "Clearing any cached Python versions..."
        rm -rf ~/.cache/pip || true
        rm -rf ~/.local/lib/python* || true
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        check-latest: true
        cache: 'pip'
    
    - name: Debug Python version
      run: |
        echo "Requested Python version: ${{ matrix.python-version }}"
        python --version
        which python
    
    - name: Clear Python cache
      run: |
        python -m pip cache purge || true
    
    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Install dependencies
      run: |
        python --version
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov black flake8
    
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=88 --statistics || true
    
    - name: Check code formatting with black
      run: |
        black --check --diff . || true
    
    - name: Test imports
      run: |
        python -c "from config import Source, SourceType, Subscription, Config, ConfigManager; print('‚úÖ Config imports OK')"
        python -c "import multi_downloader; print('‚úÖ Multi-downloader import OK')"
    
    - name: Test with pytest
      run: |
        python -m pytest -v

  docker:
    runs-on: ubuntu-22.04
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build Docker image
      run: |
        docker build -t youtube2podcast .


    - name: Test Docker image basic functionality
      run: |
        echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ Docker –æ–±—Ä–∞–∑–∞..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é Python
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–µ—Ä—Å–∏–∏ Python:"
        docker run --rm youtube2podcast python --version
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –æ—Å–Ω–æ–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π (–±–µ–∑ multi_downloader)
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª–µ–π:"
        docker run --rm youtube2podcast python -c "
        try:
            from config import Source, SourceType, Subscription, Config, ConfigManager
            print('‚úÖ Config imports OK')
        except ImportError as e:
            print(f'‚ùå Config import failed: {e}')
            exit(1)
        
        try:
            import yt_dlp
            print(f'‚úÖ yt-dlp version: {yt_dlp.version.__version__}')
        except ImportError as e:
            print(f'‚ùå yt-dlp import failed: {e}')
            exit(1)
        
        try:
            import requests
            print(f'‚úÖ requests version: {requests.__version__}')
        except ImportError as e:
            print(f'‚ùå requests import failed: {e}')
            exit(1)
        "
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å FFmpeg
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ FFmpeg:"
        docker run --rm youtube2podcast ffmpeg -version | head -1
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è SKIP_DOWNLOAD
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π SKIP_DOWNLOAD:"
        docker run --rm -e SKIP_DOWNLOAD=true youtube2podcast python -c "
        import os
        skip_download = os.environ.get('SKIP_DOWNLOAD', 'false').lower()
        print(f'üìã SKIP_DOWNLOAD={skip_download}')
        
        if skip_download in ('true', '1', 'yes'):
            print('‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è SKIP_DOWNLOAD –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞')
        else:
            print('‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è SKIP_DOWNLOAD –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞')
            exit(1)
        "
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ multi_downloader –Ω–µ –¥–µ–ª–∞–µ—Ç —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤ –ø—Ä–∏ SKIP_DOWNLOAD
        echo "üìã –ü—Ä–æ–≤–µ—Ä–∫–∞ multi_downloader —Å SKIP_DOWNLOAD:"
        docker run --rm -e SKIP_DOWNLOAD=true youtube2podcast python -c "
        import os
        import sys
        
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è
        os.environ['SKIP_DOWNLOAD'] = 'true'
        
        try:
            # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º multi_downloader
            import multi_downloader
            print('‚úÖ multi_downloader –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ')
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è SKIP_DOWNLOAD –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è
            if hasattr(multi_downloader, 'dry_run'):
                print('‚úÖ dry_run –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞')
            else:
                print('‚ùå dry_run –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞')
                
        except Exception as e:
            print(f'‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ multi_downloader: {e}')
            exit(1)
        "
        
        echo "‚úÖ –í—Å–µ –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã Docker –æ–±—Ä–∞–∑–∞ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!"
